/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * Copyright (c) 2024 STMicroelectronics.
  * All rights reserved.
  *
  * This software is licensed under terms that can be found in the LICENSE file
  * in the root directory of this software component.
  * If no LICENSE file comes with this software, it is provided AS-IS.
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include <math.h>
#include "constants.h"
#include "receiver.h"
#include "arm_math.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
int demodulate(const uint16_t * samples, int * symbs, params_r * params);
void costas_loop(float * norm_samples, float * samples_d, params_r * params);
uint8_t find_packet(float * symbs, uint8_t * bits, const int num_symbs);

/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/
ADC_HandleTypeDef hadc1;
ADC_HandleTypeDef hadc2;
DMA_HandleTypeDef hdma_adc1;

TIM_HandleTypeDef htim2;

UART_HandleTypeDef huart3;

/* USER CODE BEGIN PV */

// sampling buffers
uint32_t adc_buf[ADC_BUF_LEN];			// adc buffer
uint16_t buffer_1[ADC_BUF_LEN];			// adc buffer
uint16_t buffer_2[ADC_BUF_LEN];			// adc buffer
uint16_t adc1_reading;
uint16_t adc2_reading;

// Nathan testing code
//uint16_t HARDCODED_BUFFER[ADC_BUF_LEN] = {17546, 16242, 32841, 59247, 35066, 18458, 17070, 42481, 54577, 43592, 13291, 17592, 44961, 52175, 38820, 21096, 17280, 36410, 57760, 37829, 19871, 18104, 41460, 50079, 43568, 16573, 17631, 37744, 52482, 36901, 20735, 17084, 36730, 53887, 38364, 14781, 16943, 42925, 51984, 40324, 15103, 15716, 37686, 57055, 37745, 16256, 15232, 41711, 56064, 38653, 12778, 17128, 43746, 50382, 40716, 15080, 13952, 46823, 59075, 17001, 14682, 31546, 43232, 36637, 38709, 13288, 16042, 56855, 52049, 8834, 14491, 45767, 47735, 37638, 16926, 13220, 30890, 61871, 36505, 15354, 13952, 43924, 57665, 44541, 10158, 14752, 46290, 55375, 39578, 18280, 14987, 36782, 59920, 38546, 18394, 16317, 39986, 51999, 43876, 15226, 17034, 40204, 51936, 37141, 19051, 17320, 35962, 53819, 37840, 17432, 18206, 42270, 50433, 40695, 16587, 18272, 40524, 51349, 37461, 19824, 18475, 40549, 52961, 30725, 17690, 24288, 42448, 37771, 40713, 18236, 17770, 47199, 54389, 14595, 18475, 37150, 40895, 36495, 32953, 15637, 22088, 58035, 42240, 10530, 15642, 47391, 48801, 41800, 12522, 13449, 37499, 61759, 38185, 15568, 12298, 41788, 61264, 45663, 7342, 11936, 48867, 59423, 41637, 13227, 10655, 38327, 65264, 40761, 13290, 10912, 43718, 59551, 45936, 9298, 11083, 40605, 59858, 39291, 13055, 11364, 37398, 60351, 40057, 11944, 13086, 45086, 56129, 42049, 12570, 14880, 41712, 54251, 38484, 18128, 17066, 42721, 53520, 23640, 20282, 31056, 39176, 32620, 38845, 23559, 24250, 45004, 40063, 23648, 27989, 38452, 36648, 33989, 31001, 31534, 33392, 33274, 32957, 35452, 36120, 32150, 27306, 31420, 42294, 40157, 27446, 25256, 32183, 41011, 44437, 31250, 18863, 26784, 52576, 47362, 31028, 14674, 26355, 46023, 50848, 25180, 14330, 26752, 52176, 52255, 28953, 7216, 23169, 51695, 54848, 23811, 7354, 27127, 52066, 55119, 23263, 5192, 24348, 57727, 55793, 25622, 4362, 27414, 53877, 47962, 23574, 9844, 26936, 56601, 55421, 8660, 5807, 39301, 57042, 23530, 26038, 24264, 28123, 52511, 44157, 4287, 14208, 54895, 52966, 21066, 10370, 32102, 41120, 51116, 22544, 13032, 28527, 56520, 49057, 31091, 9002, 25608, 54336, 50450, 24143, 16352, 31343, 46943, 49061, 26849, 16474, 25496, 52480, 48031, 31794, 14264, 26275, 45615, 49021, 25165, 17794, 29045, 45949, 47892, 26858, 13449, 25786, 50655, 48405, 28022, 13514, 28428, 46352, 49211, 24762, 14201, 28664, 51783, 49632, 24778, 11258, 30888, 52208, 34991, 27753, 19385, 27898, 50815, 51521, 8393, 11418, 45174, 54624, 20286, 22402, 28850, 31299, 51653, 34316, 4648, 18108, 57926, 52837, 24150, 6395, 29789, 46320, 53518, 19766, 10346, 28648, 58223, 52272, 30186, 4224, 24084, 58176, 54302, 24891, 10656, 29033, 50895, 52753, 24488, 12106, 24390, 55395, 52127, 30674, 9157, 24302, 48681, 52240, 24128, 12047, 28613, 47538, 50287, 25481, 12256, 27100, 52663, 49504, 28556, 11906, 28218, 49168, 44294, 26252, 17586, 29168, 47935, 48469, 15819, 14991, 38478, 51669, 25082, 28922, 28434, 28758, 47141, 43189, 11136, 18125, 51924, 48194, 22624, 15232, 32484, 39129, 49215, 24430, 14195, 28196, 56023, 48509, 30654, 9115, 25510, 53776, 51583, 21978, 14373, 32218, 50765, 51200, 27379, 11177, 23394, 58960, 53023, 29959, 8474, 24415, 49450, 54352, 23332, 10650, 26154, 54034, 54322, 26091, 5414, 22400, 53998, 55505, 25380, 6186, 27009, 51440, 55119, 22570, 6196, 26024, 57631, 55056, 22936, 5194, 29760, 54498, 39581, 26123, 15295, 27368, 53133, 53373, 7183, 10139, 44526, 54768, 20905, 23946, 29662, 30766, 48319, 34140, 10664, 22958, 54175, 45889, 27445, 14283, 29809, 44545, 44575, 24895, 24101, 32592, 39517, 40392, 33965, 25522, 31009, 39424, 36505, 32406, 31249, 33181, 33200, 32551, 33902, 36475, 34620, 29834, 28313, 34388, 41557, 36770, 23160, 24721, 39253, 44034, 37290, 20397, 20272, 36123, 52623, 36977, 17983, 17026, 41801, 54752, 41118, 12458, 14794, 43098, 56399, 39881, 12538, 11003, 49434, 62833, 20776, 9630, 24582, 47008, 46035, 41137, 7910, 9772, 62889, 61969, 3516, 8106, 41632, 53296, 39967, 18458, 6817, 24527, 65535, 45693, 5579, 8253, 50103, 62335, 44613, 4283, 9352, 44897, 62363, 37648, 14484, 11323, 38966, 62672, 40524, 15519, 14568, 42817, 52831, 44293, 15668, 17743, 39327, 49815, 36150, 22088, 21136, 34560, 47999, 35884, 23892, 25352, 37647, 40880, 35591, 27822, 29143, 34922, 36267, 33900, 32566, 33328, 32560, 31752, 33748, 36208, 32587, 31694, 29691, 31336, 39893, 40563, 19554, 23530, 44456, 42992, 24076, 25510, 31542, 33097, 46559, 31854, 10976, 24030, 56410, 49088, 27173, 7935, 28226, 47472, 52607, 20352, 11168, 29572, 56832, 52861, 29844, 2971, 23424, 60144, 56159, 24763, 7776, 29093, 53852, 55856, 23258, 6715, 22191, 59856, 55967, 29382, 4915, 23129, 52298, 56656, 22304, 7387, 26912, 52607, 54712, 23806, 6609, 24939, 55983, 53829, 26926, 6847, 27256, 50961, 46343, 24971, 14176, 28247, 51839, 51409, 12282, 11807, 39570, 53216, 23733, 27822, 28512, 29002, 47746, 41008, 10722, 19391, 52881, 47520, 23392, 14523, 32153, 41009, 47855, 23936, 17376, 30140, 51973, 46053, 31722, 12930, 26837, 52433, 47775, 25419, 18816, 30280, 44698, 47953, 26805, 17946, 26555, 50165, 47770, 31973, 13528, 25594, 47143, 49904, 24526, 14650, 28724, 47458, 50271, 25384, 10698, 25517, 53485, 51781, 27687, 8603, 26913, 49584, 52204, 22872, 9568, 27277, 56889, 54434, 17740, 5374, 32660, 56594, 34062, 26154, 15021, 26496, 55853, 55679, 3968, 4894, 47927, 59392, 18294, 16595, 26669, 33690, 55116, 32250, 776, 16696, 61375, 54768, 26597, 3307, 26546, 51968, 54623, 20651, 11181, 31442, 53397, 51009, 29349, 11277, 24144, 57056, 49756, 31064, 14432, 26654, 44060, 47264, 26812, 21855, 29909, 41109, 42463, 30293, 22816, 29739, 41174, 38753, 31137, 28651, 32366, 35459, 34720, 33121, 33314, 33611, 31866, 31122, 35134, 38316, 32035, 27434, 30010, 37254, 34738, 36793, 23624, 23178, 45594, 48613, 16329, 21647, 39091, 40260, 35529, 29866, 16160, 24682, 58911, 39092, 10849, 14586, 48161, 51889, 43156, 9482, 11984, 39289, 63435, 38480, 14011, 10490, 41637, 64049, 46175, 6619, 10368, 49463, 60991, 43577, 10368, 9856, 37489, 64480, 40818, 13371, 10504, 41025, 60127, 45664, 8959, 11498, 42855, 58657, 39710, 11650, 12086, 37168, 60095, 39254, 13966, 13726, 43236, 56447, 39613, 12799, 17464, 43537, 47743, 40610, 17285, 16362, 45579, 55536, 16464, 18729, 36259, 40016, 35571, 34076, 18341, 23579, 55032, 37265, 15285, 19978, 45582, 46768, 41055, 15897, 19575, 39450, 52835, 35036, 22357, 18857, 37161, 55935, 40266, 16347, 19172, 45824, 49611, 41922, 19272, 18105, 35758, 54288, 37672, 20728, 17462, 38296, 52055, 42321, 14682, 16514, 41231, 53488, 38332, 15694, 14704, 36438, 57983, 39185, 13796, 13823, 44571, 56800, 42155, 10895, 13224, 42691, 57788, 39653, 12776, 11402, 48799, 61823, 20170, 11406, 25712, 46082, 41737, 41879, 10741, 12328, 57919, 58688, 5618, 12058, 44199, 49840, 37370, 18443, 11198, 29078, 63103, 37657, 13484, 12847, 45615, 57296, 44590, 9998, 14774, 45923, 54683, 39206, 19585, 16781, 36043, 56736, 37481, 22186, 20178, 37120, 46423, 40976, 20833, 23424, 38344, 42451, 34992, 25854, 26789, 33901, 39776, 35048, 29701, 30737, 34230, 34386, 33373, 33955, 34654, 32449, 29866, 32001, 38163, 38817, 28088, 24345, 34294, 43925, 29058, 30502, 28336, 29230, 44911, 45093, 11252, 17640, 50083, 50815, 22112, 16002, 31593, 37056, 52031, 25474, 6624, 22959, 61244, 54141, 28091, 2078, 24776, 54896, 57663, 19035, 3254, 28782, 59063, 57408, 26520, 969, 21571, 64768, 59533, 27243, 1305, 26838, 56019, 59344, 21707, 1562, 23016, 58451, 57839, 24456, 3175, 21599, 56207, 57137, 25248, 5506, 26800, 51056, 54351, 22626, 9194, 27520, 55119, 51888, 21069, 10634, 32605, 52288, 29741, 29019, 26208, 28554, 44462, 44629, 15927, 21534, 46047, 41680, 26418, 25048, 33013, 36249, 38603, 29518, 28418, 32175, 36010, 34529, 33116, 34080, 33736, 31174, 30793, 35863, 38223, 34809, 29161, 26753, 33910, 44628, 36956, 26351, 23544, 36521, 45065, 41968, 19371, 20029, 38351, 51252, 36570, 20536, 16636, 36704, 55823, 38945, 12960, 14464, 44559, 56177, 41451, 11275, 11717, 38928, 62493, 39699, 11424, 10154, 47786, 62256, 31730, 7887, 17412, 45600, 54609, 41952, 9270, 8447, 56142, 64721, 8393, 9519, 35616, 49458, 39737, 27322, 8912, 20956, 64543, 48672, 5922, 10991, 49219, 54977, 43259, 8074, 12026, 41412, 60079, 36763, 17455, 14239, 38484, 60224, 40685, 16282, 17642, 44135, 49223, 42879, 18743, 20537, 36763, 46496, 35154, 26609, 23920, 34121, 43830, 36305, 25507, 27898, 36188, 38136, 34489, 30750, 31544, 33744, 33326, 33000, 35188, 35981, 31202, 28062, 32573, 40166, 34758, 30314, 26998, 30460, 41989, 43665, 16920, 19631, 41887, 47431, 23265, 27471, 29792, 30262, 48677, 37447, 7400, 18440, 56303, 52080, 22296, 7808, 30933, 43840, 54398, 20698, 6331, 24984, 62414, 55297, 28627, 1163, 23198, 59073, 58447, 19023, 2784, 30078, 57648, 57600, 23481, 1408, 21078, 64195, 58463, 28459, 3104, 22889, 53854, 58384, 21416, 5066, 25664, 55138, 55967, 23379, 4855, 22540, 55935, 54469, 26928, 7298, 26948, 49202, 50287, 23960, 13664, 28827, 50367, 49104, 19860, 14783, 34677, 50160, 28418, 30059, 29065, 29691, 41515, 40976, 21545, 25343, 42755, 38725, 28907, 29284, 33079, 34464, 35015, 33052, 33299, 33801, 31522, 30679, 34926, 39301, 35511, 25362, 26948, 40331, 41866, 35985, 26952, 22879, 34742, 51616, 36667, 22681, 20066, 39456, 48607, 43552, 16240, 16943, 38730, 54288, 37655, 17930, 13930, 37651, 58495, 40053, 10743, 12238, 45205, 58833, 41930, 9450, 10051, 39159, 64023, 40501, 10145, 8986, 48767, 63101, 30323, 7323, 17249, 45602, 55099, 41881, 9352, 8493, 55315, 64639, 9995, 10073, 34061, 48392, 39327, 31318, 10240, 18696, 62319, 49200, 7153, 13002, 48040, 50673, 41225, 12416, 14210, 37875, 59143, 36573, 19710, 17099, 38391, 55793, 42111, 16123, 20622, 44753, 45437, 40224, 23169, 23859, 34157, 42291, 35369, 29874, 27741, 33987, 38300, 35057, 30516, 31560, 33771, 33912, 33080, 34602, 35476, 32303, 28664, 31620, 39175, 39281, 31116, 23386, 30562, 44193, 41055, 27672, 21920, 29727, 45467, 46491, 17621, 15135, 37772, 52887, 25065, 28234, 25800, 27614, 51571, 46672, 4000, 12120, 53757, 56064, 19744, 9531, 29771, 39110, 56031, 24363, 765, 18350, 63935, 57201, 27017, 1211, 25963, 56432, 59343, 18395, 1258, 27226, 59923, 57828, 26541, 987, 21665, 64624, 58783, 27950, 3692, 24124, 53607, 57552, 22310, 6986, 25216, 54960, 54511, 25099, 6568, 22936, 52718, 52673, 27059, 10682, 28256, 46645, 49071, 24991, 16608, 29644, 46043, 45437, 26840, 19023, 32420, 45521, 31461, 31079, 29760, 31275, 37525, 37708, 29380, 30155, 34933, 34379, 33306, 33962, 33921, 31431, 29743, 33455, 41169, 35209, 27428, 26086, 36504, 45763, 38886, 19609, 22565, 42273, 48063, 36375, 23506, 18783, 36583, 58304, 38712, 16953, 16928, 45618, 53015, 43793, 14391, 14383, 36791, 58529, 39184, 16442, 12708, 39537, 58517, 43857, 9600, 11850, 43247, 59120, 40053, 10586, 10616, 37297, 62591, 40545, 11178, 10880, 46111, 60192, 39767, 9034, 13856, 44098, 55821, 40510, 12733, 11594, 48815, 61055, 17060, 13342, 31056, 44099, 36726, 38336, 13650, 17433, 57183, 49072, 10446, 16078, 45758, 46272, 38492, 17338, 15925, 33578, 59167, 35463, 19181, 17281, 40866, 54993, 43411, 13897, 18473, 45439, 50436, 40161, 21781, 18728, 35858, 55456, 37338, 21805, 19573, 38641, 48561, 42752, 18100, 19496, 38767, 49571, 36387, 21483, 18824, 35880, 52463, 37705, 17328, 18506, 42499, 50384, 40643, 16111, 17147, 40294, 54831, 37605, 17487, 16031, 42181, 56240, 29753, 14466, 23026, 44387, 41281, 42168, 14014, 13696, 51295, 59457, 10156, 13995, 38099, 45780, 38560, 28991, 11103, 21128, 62663, 46860, 6498, 11498, 49019, 54049, 42065, 8832, 10376, 37973, 65059, 39013, 13728, 10634, 41655, 63253, 45893, 7674, 11912, 48960, 58143, 43728, 12904, 12767, 36488, 59216, 39105, 17855, 14876, 38523, 53991, 41264, 14561, 17422, 41664, 49954, 38522, 18493, 19770, 36058, 50439, 35570, 23483, 23247, 36958, 44848, 36234, 24202, 27755, 36947, 36773, 34817, 30423, 30794, 34167, 34451, 33813, 33938, 32481, 32467, 31783, 32364, 38633, 36496, 22944, 26488, 46074, 41437, 25524, 20218, 32010, 38624, 46869, 25442, 15648, 28824, 55902, 48416, 30416, 7914, 24992, 54480, 53647, 20664, 10726, 31462, 54474, 54576, 26153, 4027, 21910, 63184, 57600, 28248, 3712, 23865, 54931, 58816, 21622, 1483, 22765, 59121, 58751, 24363, 1349, 21528, 57767, 59328, 23732, 1674, 25933, 54787, 57847, 21594, 3126, 24760, 59435, 56387, 19367, 4351, 31635, 55675, 34972, 26753, 17890, 27227, 51452, 51553, 7812, 12954, 47151, 50883, 22372, 21418, 32245, 34519, 45407, 28952, 17584, 28856, 48863, 41085, 32245, 22459, 30829, 42006, 38878, 29478, 29080, 33088, 35226, 34617, 33268, 33387, 33512, 31994, 31265, 34804, 37525, 35292, 28109, 27408, 35565, 41595, 35935, 27532, 23512, 34803, 48167, 36734, 18824, 20474, 41501, 48176, 39751, 16523, 16627, 37799, 57144, 37925, 15282, 13982, 43287, 58082, 40101, 10042, 13739, 43778, 57102, 40537, 10912, 9600, 51830, 64080, 16429, 9114, 26790, 47461, 44079, 38869, 7760, 11582, 63933, 60176, 3104, 8874, 45418, 54128, 38847, 14282, 8160, 28996, 65535, 41008, 10592, 9870, 47103, 61821, 45223, 6954, 12000, 47395, 57919, 40135, 16480, 14171, 36433, 59344, 38395, 19919, 17725, 38153, 49149, 41783, 18562, 21233, 39387, 44822, 35625, 23682, 24644, 34235, 42967, 35553, 27606, 28888, 35146, 37012, 34068, 31938, 32763, 33306, 31880, 32523, 36686, 37325, 28384, 26476, 34901, 41637, 28899, 31030, 29067, 29866, 43055, 43621, 13776, 19818, 48390, 46997, 23122, 19726, 31735, 35072, 49470, 27998, 9138, 23680, 58415, 51216, 28448, 5178, 25853, 51583, 54233, 20543, 9760, 30296, 56251, 53713, 29011, 3979, 22774, 61558, 56078, 28070, 6986, 25448, 52572, 55671, 23431, 8378, 24688, 55935, 54772, 27471, 5415, 22620, 52696, 54909, 25027, 7594, 27544, 49698, 53231, 23374, 9568, 27256, 55103, 52229, 24342, 8874, 30083, 52351, 36970, 27609, 19040, 28074, 49799, 50513, 10145, 13514, 44133, 52080, 21714, 25834, 29906, 30672, 47846, 35491, 10180, 21662, 54424, 47852, 24704, 12591, 31033, 42965, 49091, 22463, 16437, 30338, 52127, 47268, 31620, 10746, 26018, 54240, 49695, 25034, 16352, 30382, 46999, 49780, 25901, 15594, 25636, 52400, 49823, 31358, 11226, 24879, 48047, 51472, 24018, 12674, 28390, 48720, 51242, 25050, 9945, 25368, 53871, 52117, 27664, 8494, 26946, 49747, 49994, 23659, 11808, 27992, 54756, 52768, 14601, 8463, 35957, 55120, 25930, 27362, 23136, 27022, 52054, 48240, 4798, 12831, 52910, 53811, 20768, 11531, 31759, 38695, 51757, 23936, 10272, 25898, 58959, 50737, 29969, 7042, 25009, 53920, 52231, 21706, 14370, 32389, 49923, 50353, 26977, 13707, 24293, 56032, 50143, 31133, 12357, 25730, 46199, 50385, 25000, 16526, 28392, 47617, 48689, 27432, 12554, 25217, 50455, 48737, 27757, 13599, 28600, 46017, 49044, 25049, 14591, 28705, 51658, 48897, 26804, 12162, 29893, 50930, 38349, 27612, 19232, 28415, 49323, 50133, 10920, 13050, 43119, 53088, 21368, 24634, 29270, 30967, 50303, 34543, 6448, 19275, 56941, 51664, 24307, 7554, 30295, 45106, 52894, 20152, 10815, 28737, 58045, 52305, 30164, 3835, 23952, 58384, 54895, 23295, 10080, 30525, 52591, 53862, 24109, 9631, 22848, 58848, 54111, 30182, 7116, 24016, 49707, 54468, 22872, 10554, 27604, 50866, 52415, 24686, 9157, 24783, 53559, 51569, 27996, 10139, 27402, 48293, 48402, 24686, 15328, 29167, 48911, 48291, 19744, 15262, 35701, 50289, 27489, 29879, 28822, 29327, 43225, 42435, 17520, 22750, 46420, 41729, 26080, 23256, 32877, 37491, 40543, 27454, 25440, 31673, 39401, 38112, 32270, 27370, 31917, 38593, 36684, 31438, 30301, 32959, 35085, 35064, 33007, 31850, 32854, 34108, 33772, 33296, 33330, 33475, 32916, 32840, 33629, 34398, 33683, 32387, 32032, 33743, 35233, 34075, 31546, 31667, 34088, 35554, 33997, 31438, 31394, 34086, 35768, 34022, 31402, 31460, 34713, 56752, 37460, 10937, 16992, 44544, 50039, 41492, 14021, 13184, 48896, 59648, 13600, 14905, 35221, 43011, 37151, 33698, 14244, 21188, 58598, 42721, 10664, 15870, 47383, 49073, 42157, 13006, 15793, 39462, 57231, 36170, 19680, 16333, 38547, 57875, 42383, 13775, 17421, 46672, 51277, 42320, 18276, 17417, 35862, 54544, 37605, 21039, 17797, 37751, 50975, 40831, 15648, 18048, 41395, 50752, 38116, 17722, 17367, 36073, 54601, 37538, 17616, 17230, 41399, 53072, 40609, 14687, 17640, 42565, 48384, 40263, 16895, 15791, 45677, 57106, 16962, 16395, 33010, 41696, 36327, 37537, 14304, 18264, 57567, 47713, 9661, 14976, 46411, 47680, 38367, 16266, 13169, 31926, 62239, 36801, 14822, 13274, 44894, 57471, 44763, 9088, 13536, 46207, 57518, 38207, 17000, 13293, 37759, 61904, 39628, 15902, 14368, 43300, 54719, 44721, 13456, 14815, 38880, 55360, 37664, 18248, 15240, 36663, 55798, 38659, 14632, 16398, 43527, 51984, 41018, 15390, 16688, 40291, 54463, 37458, 18593, 17370, 41177, 53877, 29618, 17418, 25621, 42341, 36270, 40871, 18504, 18312, 49173, 50544, 13329, 19866, 41430, 41840, 35254, 25196, 17792, 28586, 57583, 34936, 16935, 17946, 45257, 51969, 43037, 12303, 17032, 43521, 54173, 36679, 19897, 15609, 37575, 60256, 39583, 15674, 15264, 45520, 54540, 44273, 13216, 13854, 37414, 58239, 38991, 16398, 12608, 38743, 58971, 41664, 9930, 12015, 44473, 58721, 41058, 10203, 10800, 38352, 62831, 39912, 11554, 10714, 46821, 61140, 34509, 9215, 17548, 45251, 51094, 42017, 12232, 11437, 51145, 61520, 11978, 13785, 36779, 44576, 37663, 30034, 14362, 23509, 58863, 38928, 13356, 17562, 46283, 49789, 42034, 14360, 20098, 41420, 48352, 34592, 26553, 23273, 34836, 47296, 37358, 27210, 27624, 35984, 38230, 34909, 30752, 31480, 33576, 33419, 32970, 35151, 36079, 32476, 27872, 31146, 39982, 39968, 28808, 23947, 30439, 40249, 43738, 27900, 18152, 28277, 49556, 46929, 29089, 13562, 27894, 48225, 47449, 24670, 13857, 28392, 53295, 52177, 14904, 8399, 35591, 55677, 27438, 26954, 20384, 26585, 54415, 51568, 2745, 8576, 51911, 57888, 19387, 11850, 29034, 36800, 54835, 26426, 2336, 20352, 62155, 54529, 28139, 2522, 24906, 53808, 55540, 20096, 9568, 31168, 54723, 52913, 27687, 8841, 23037, 59826, 53279, 29882, 9578, 24922, 47755, 52322, 24426, 14426, 27551, 50018, 50079, 28063, 11136, 24553, 50028, 49760, 26722, 13342, 28933, 45657, 48675, 25530, 15020, 28700, 51199, 47937, 27937, 13518, 29556, 49760, 39468, 27676, 20839, 28847, 47263, 48289, 13706, 15278, 41237, 51312, 23259, 27366, 29672, 30206, 47901, 37829, 9584, 19695, 54431, 49145, 23546, 11279, 31380, 42720, 50751, 21791, 13236, 28652, 56915, 50293, 30620, 6427, 24757, 56160, 53253, 22959, 12064, 30848, 51261, 52736, 24522, 11003, 23364, 57974, 53535, 30344, 7504, 24060, 49791, 54578, 22760, 10042, 27334, 51664, 53311, 24255, 7573, 23936, 54831, 53365, 27314, 7646, 26846, 49746, 50361, 23626, 12134, 28104, 53575, 51909, 14625, 10379, 36476, 53760, 25854, 28171, 25417, 27659, 49271, 45584, 9002, 16173, 52205, 49574, 22252, 15234, 32563, 38120, 48829, 25176, 14696, 28324, 54879, 47089, 31093, 11594, 26353, 52338, 49257, 23224, 17696, 32188, 47023, 48849, 28065, 15614, 25040, 54561, 48671, 31295, 13528, 26079, 45884, 50161, 25130, 16410, 28122, 48597, 49503, 27967, 10933, 24336, 50815, 50961, 26624, 10922, 28219, 47536, 51542, 23983, 10786, 27485, 54895, 52480, 23913, 7631, 30276, 53984, 37103, 26606, 16120, 27181, 54041, 54320, 5794, 7695, 46262, 57568, 19104, 19230, 27574, 31716, 53959, 35091, 1504, 16184, 60185, 54581, 25133, 4267, 28976, 48656, 54711, 19502, 9568, 29492, 56935, 52225, 30150, 6528, 23801, 59120, 52681, 29071, 11636, 25902, 46790, 50465, 25777, 17306, 27944, 46993, 46553, 31516, 16433, 26906, 46175, 43872, 28129, 21962, 30813, 39640, 40382, 29947, 26464, 31566, 37600, 36401, 32392, 31151, 33103, 33307, 32954, 34120, 35339, 34597, 28770, 28365, 38739, 42179, 22708, 26137, 36620, 37143, 34740, 35814, 19991, 23369, 54071, 41893, 13048, 17835, 46333, 47136, 40959, 14466, 13309, 34534, 63183, 38356, 13908, 10831, 44221, 63253, 45803, 4635, 9376, 48288, 65311, 39525, 10504, 7386, 40484, 65535, 42602, 9295, 7328, 45971, 65535, 46801, 5920, 7435, 40214, 65535, 41085, 9146, 7861, 39287, 63903, 41525, 8736, 9738, 46391, 60421, 42390, 9354, 12450, 42528, 56783, 39415, 15264, 14270, 45423, 56897, 20010, 17855, 32106, 39721, 33531, 38269, 21082, 22938, 49087, 38352, 20288, 25704, 41328, 38895, 34911, 26106, 29092, 35287, 36754, 33602, 32415, 33461, 33045, 31527, 32573, 36887, 36760, 31086, 27680, 32104, 37823, 40928, 29904, 24299, 28866, 43536, 43823, 32814, 17568, 27163, 44908, 48561, 25306, 17034, 28800, 47588, 49790, 25626, 10240, 24448, 53359, 52449, 27069, 8322, 27052, 49864, 53679, 22574, 8169, 26893, 57601, 55025, 16373, 4992, 33296, 56957, 32601, 26273, 16420, 26473, 55167, 53968, 3316, 7343, 50583, 57973, 19232, 14074, 29194, 35491, 53699, 28170, 4246, 20924, 60789, 52933, 28595, 4379, 25087, 52607, 53451, 21130, 12650, 31768, 52531, 50653, 29572, 11167, 24072, 57471, 50764, 30602, 12476, 25834, 45935, 50165, 25431, 17183, 28329, 47217, 47892, 28994, 13614, 25537, 49247, 47681, 27583, 15306, 29071, 44749, 47391, 25887, 16830, 29327, 48671, 46624, 27817, 15054, 30606, 49530, 36689, 28394, 22240, 28822, 47067, 48240, 12498, 15338, 43506, 51011, 21800, 25234, 29943, 31272, 49323, 33756, 7440, 20381, 57038, 51185, 25915, 6655, 28905, 47152, 53437, 19768, 10016, 29099, 57972, 53489, 29635, 2059, 23220, 60608, 56703, 24250, 7023, 29593, 54529, 56432, 23025, 5421, 21730, 60662, 56798, 29135, 4464, 23032, 52849, 57456, 21738, 6794, 26451, 53872, 55335, 23550, 5630, 23647, 56089, 54065, 27178, 7194, 26956, 49745, 48108, 24656, 14592, 28758, 49647, 49216, 16682, 15176, 38105, 50016, 26087, 29986, 30386, 30128, 41681, 39622, 21356, 26063, 43132, 38453, 29421, 29202, 33047, 34915, 34696, 33027, 33302, 33683, 31960, 31019, 34686, 39064, 35426, 25914, 27185, 39805, 41484, 36946, 25014, 23144, 34455, 49346, 36545, 23352, 19988, 37568, 48983, 42641, 15864, 17035, 40465, 53631, 38005, 16142, 13997, 36599, 58901, 39807, 11816, 12510, 45532, 58321, 42422, 9610, 10956, 41137, 62559, 39729, 11263, 10062, 48688, 62512, 26071, 9499, 21700, 46236, 47295, 42725, 10788, 10536, 54968, 62335, 7726, 12266, 39954, 47811, 38104, 25119, 11873, 24492, 61727, 40573, 10833, 13898, 47811, 53365, 43765, 9370, 14976, 43970, 55535, 36595, 19770, 16047, 36963, 59232, 38207, 19072, 18032, 41504, 49622, 43384, 17403, 18895, 38390, 49939, 36219, 22027, 19355, 35666, 51369, 37237, 18747, 19914, 41684, 48358, 39986, 17919, 19199, 39920, 50949, 37246, 20234, 18850, 41081, 53024, 26402, 18446, 27552, 41776, 35428, 40939, 17348, 17692, 51885, 50965, 10941, 17386, 43117, 44512, 36274, 21576, 14336, 28648, 61071, 37008, 12577, 13774, 47823, 54224, 44062, 7646, 12328, 41874, 61703, 37648, 14880, 11183, 40681, 63424, 45709, 8123, 11216, 49344, 59743, 43647, 11177, 10570, 37223, 63664, 40590, 13978, 11072, 40615, 59487, 44948, 9416, 11994, 43525, 57888, 40126, 11934, 12674, 37683, 59391, 38384, 15343, 14783, 41725, 55536, 36020, 15042, 21180, 42904, 40210, 40246, 20521, 19855, 44303, 49790, 18838, 24043, 38003, 37379, 33766, 33229, 26528, 29656, 40831, 35285, 28900, 30730, 34869, 34285, 33341, 33963, 34754, 32219, 29746, 32121, 37245, 38944, 32918, 22814, 29740, 47487, 42719, 29386, 21672, 29736, 43116, 47265, 26836, 17794, 26596, 51616, 49631, 31210, 10279, 24476, 49195, 53570, 22996, 9487, 27190, 52720, 55017, 23464, 4388, 22490, 58191, 57169, 25657, 3458, 26182, 54832, 55663, 21050, 2867, 24968, 61211, 58705, 10240, 1451, 37744, 60257, 29947, 25114, 13932, 26568, 57063, 53057, 1785, 5691, 53760, 58576, 19430, 10050, 29927, 38232, 53482, 24299, 8064, 24888, 59743, 50880, 30169, 7915, 25426, 53248, 50319, 23256, 18016, 32265, 44406, 46336, 28730, 21246, 27965, 43585, 42169, 33778, 23712, 30093, 39368, 38777, 31040, 29179, 32320, 35191, 34586, 33277, 33910, 33751, 31452, 30848, 34818, 38282, 35166, 27102, 26905, 37137, 42808, 35936, 24945, 23113, 38737, 49789, 28563, 20298, 27186, 41459, 36116, 40996, 16966, 16957, 51161, 54789, 10128, 15710, 40363, 45126, 37611, 26507, 11394, 23428, 63319, 44822, 6699, 10624, 49583, 56864, 42890, 6200, 8772, 39827, 65535, 39601, 11336, 8202, 42470, 65535, 46751, 6174, 8888, 50047, 62964, 44321, 8928, 9215, 37657, 63936, 40894, 13498, 10579, 40259, 59856, 44103, 9803, 12674, 43543, 56592, 40044, 13291, 14387, 37534, 57017, 37441, 17724, 17387, 39707, 51975, 37454, 18121, 22641, 40994, 38162, 38401, 24499, 23839, 40020, 44100, 23916, 27818, 35929, 35718, 33916, 33365, 31650, 32351, 33225, 33145, 35574, 35709, 31416, 28575, 32138, 38499, 39992, 26782, 24620, 31287, 42727, 43233, 32738, 15750, 27561, 51409, 47909, 24687, 17656, 30352, 47361, 49829, 25512, 13698, 24416, 55666, 52699, 30422, 7432, 23853, 50575, 55744, 22144, 7967, 26256, 54631, 56299, 23026, 3429, 21376, 58239, 57936, 25289, 3099, 26096, 54561, 56301, 21120, 3594, 25231, 60607, 57872, 11982, 2944, 35916, 58992, 30258, 25786, 16224, 26641, 55276, 53425, 3108, 8335, 51439, 56580, 20404, 13146, 31089, 36422, 50987, 26091, 10848, 25800, 57039, 47968, 30725, 11930, 26664, 51121, 47253, 24424, 21918, 32905, 41301, 43269, 31264, 24374, 29580, 39686, 38868, 33041, 28352, 32089, 35610, 35303, 32896, 33354, 33752, 31865, 30799, 34147, 38672, 35401, 27146, 27071, 37335, 42247, 36636, 22634, 23060, 38641, 49150, 36053, 21618, 19738, 39727, 52433, 32202, 16207, 22320, 43506, 41562, 41749, 14653, 13999, 49983, 60005, 11396, 13390, 35760, 46048, 39053, 31560, 9832, 18622, 63903, 51905, 4300, 9802, 48902, 56356, 40236, 7739, 8149, 36887, 65535, 39952, 11042, 8362, 44198, 65264, 46287, 4938, 9556, 49858, 61567, 43344, 10656, 10303, 37139, 62591, 40246, 15232, 12455, 39667, 57111, 43013, 11976, 14938, 43028, 53104, 39755, 15871, 17138, 36914, 53486, 36359, 20851, 20522, 37926, 48435, 37120, 21427, 25376, 39056, 36862, 36113, 28036, 27610, 36965, 38713, 30672, 30851, 33614, 33815, 32982, 33727, 35462, 33507, 28128, 30409, 41651, 38849, 29236, 22042, 31866, 41821, 43828, 24031, 21357, 31122, 48251, 45893, 32004, 11486, 26032, 54720, 50798, 24176, 14005, 30838, 50616, 52564, 24826, 9775, 22597, 60466, 55455, 29433, 5428, 23279, 52791, 57727, 21627, 3787, 24552, 57331, 58075, 22939, 1888, 20952, 58624, 59261, 24491, 1311, 25970, 55376, 57358, 20842, 2351, 24813, 60787, 57936, 13226, 3067, 35980, 58560, 28830, 26159, 18784, 26829, 53665, 49729, 3936, 12175, 52999, 53200, 21247, 12674, 32634, 39109, 48927, 24351, 16688, 29828, 51423, 44257, 32348, 16891, 28448, 47777, 42324, 27539, 26176, 32959, 37043, 38077, 32352, 29619, 32282, 34866, 33866, 33512, 34404, 34145, 30529, 29988, 34954, 38963, 35273, 27611, 26000, 34247, 45527, 36363, 22929, 22685, 39774, 46653, 39759, 18313, 19321, 40483, 51607, 38049, 18097, 16010, 43502, 56673, 25539, 14634, 24921, 44452, 39907, 42423, 12740, 13273, 55056, 57809, 6456, 12766, 43487, 49136, 37566, 19418, 10400, 27326, 64479, 39991, 10624, 10686, 48071, 59936, 45005, 6106, 10976, 45779, 60719, 37648, 14899, 11392, 38826, 63440, 40890, 14222, 13032, 44887, 56351, 44769, 12640, 13976, 37965, 56482, 38082, 18350, 15120, 36960, 55513, 38647, 14440, 16699, 43149, 51296, 40393, 16174, 17332, 38695, 54350, 36698, 19386, 18335, 39907, 52529, 32113, 18186, 24928, 41968, 36217, 40352, 19624, 19338, 48319, 50464, 14438, 20690, 40714, 40914, 34980, 26635, 18359, 27860, 56805, 35127, 16760, 18383, 45503, 50865, 42669, 12232, 17224, 42647, 54351, 36130, 19916, 15647, 37948, 60098, 40681, 14250, 15200, 46949, 54839, 44064, 13409, 13696, 37137, 58784, 39273, 16282, 12560, 39381, 58719, 43120, 9670, 11946, 43863, 58884, 40629, 10399, 10720, 37841, 62699, 40213, 11491, 10746, 46387, 60704, 38101, 8927, 14824, 44480, 54303, 41127, 12530, 11547, 49791, 61244, 14308, 13705, 33532, 43779, 36848, 35797, 14488, 19145, 57148, 44757, 12025, 17834, 46038, 46017, 40300, 17048, 19652, 37794, 51607, 34285, 25620, 22872, 35309, 47908, 38789, 23455, 26891, 38822, 38959, 34833, 30291, 30713, 33595, 34455, 33525, 33964, 34633, 32793, 29584, 31791, 38047, 38753, 29979, 25590, 30710, 39248, 42655, 28313, 19124, 28398, 48630, 46133, 29156, 14383, 28057, 47487, 48559, 24287, 13156, 28235, 54175, 52599, 17489, 7242, 33652, 56288, 31520, 26398, 16357, 26346, 56399, 55409, 2912, 4224, 50771, 60720, 17524, 12591, 25758, 36457, 57631, 30472, 680, 11392, 63775, 58048, 24864, 1930, 28640, 53456, 58361, 18456, 3296, 28056, 59263, 55344, 28634, 2059, 22724, 61872, 55518, 28662, 8200, 25035, 49385, 52817, 24692, 14398, 27276, 49713, 48799, 29406, 13657, 25695, 48116, 46133, 27816, 19074, 30155, 41621, 42485, 28532, 24096, 30997, 39715, 38465, 31343, 28671, 32923, 35702, 33872, 33105, 33461, 33593, 31401, 31240, 36847, 38073, 26402, 28300, 37221, 36896, 34704, 32803, 23019, 27273, 51555, 35943, 16610, 20750, 45551, 46273, 41119, 15081, 16489, 37192, 59117, 37241, 16906, 13631, 41922, 60192, 45502, 7391, 11835, 48208, 60479, 40021, 12853, 9344, 39666, 65535, 43303, 10698, 8737, 47153, 64287, 46081, 7010, 8000, 39039, 65535, 41431, 10522, 7824, 40624, 64191, 43413, 7141, 8878, 45739, 62257, 42113, 8378, 9888, 40240, 62724, 39397, 12691, 11802, 45967, 59261, 27352, 13643, 24960, 43856, 37083, 41586, 17652, 17935, 50397, 48767, 15250, 21914, 41809, 40081, 34934, 24875, 24377, 34083, 44826, 34269, 28615, 28900, 34991, 37217, 34335, 31578, 32699, 33377, 31890, 32622, 36057, 37460, 32040, 26522, 30497, 39700, 40841, 33221, 21664, 28942, 42025, 45105, 27028, 20870, 29000, 45093, 47359, 28016, 12941, 25149, 50878, 50240, 27104, 10826, 28024, 47799, 52158, 23610, 9638, 27037, 55983, 53631, 23697, 6090, 29776, 54578, 39653, 25864, 14143, 27016, 54972, 55136, 5745, 6586, 44643, 57904, 19755, 20866, 27116, 31323, 53519, 36880, 2192, 16008, 58815, 53813, 24344, 5551, 29324, 47427, 53519, 20047, 11323, 30028, 55735, 51168, 30526, 7337, 24180, 58224, 52294, 28472, 12091, 26778, 47647, 51008, 25475, 15307, 26521, 50994, 49439, 31070, 12024, 25006, 48269, 49665, 25170, 14474, 29184, 45601, 48535, 26206, 14122, 27497, 51920, 48225, 28926, 12986, 28256, 48593, 45119, 25984, 17410, 29214, 48390, 48753, 16288, 14031, 37877, 52432, 25120, 28583, 27448, 28346, 48663, 43953, 8901, 16383, 52911, 50547, 21674, 12674, 32228, 39858, 51054, 23519, 11323, 26766, 58627, 50944, 30050, 5947, 24773, 54391, 53534, 20864, 12078, 31914, 52669, 52449, 26624, 9801, 22978, 59856, 53715, 29885, 8224, 24383, 49227, 54050, 23304, 11738, 27050, 52351, 52761, 25563, 7809, 23260, 52456, 52949, 26436, 9242, 27908, 48144, 51855, 23774, 11365, 27907, 53951, 51071, 24769, 10126, 30341, 51936, 35979, 27811, 20320, 28158, 49135, 49973, 10407, 14095, 44847, 51442, 21530, 24623, 30424, 31410, 47897, 33610, 10312, 22685, 55199, 47765, 26912, 10882, 28680, 46144, 49732, 21822, 16224, 30872, 51703, 48177, 31594, 10114, 25272, 56001, 50271, 27606, 14624, 28174, 47306, 50557, 25526, 14858, 25787, 52704, 50655, 31049, 10189, 24554, 48501, 52320, 23741, 11563, 28148, 49474, 51990, 24712, 9005, 24844, 54479, 52992, 27383, 7554, 26752, 50134, 51551, 23067, 10272, 27496, 56125, 53744, 16466, 7131, 33970, 55664, 29540, 27112, 19898, 26639, 53007, 51317, 4283, 10751, 50876, 55303, 20715, 13962, 31040, 36407, 51660, 25896, 8901, 24232, 58799, 50448, 29723, 7882, 25505, 52246, 51088, 22238, 16372, 32768, 48063, 48325, 29707, 16002, 25581, 53281, 46797, 31600, 17529, 27704, 42216, 45408, 27671, 23106, 29539, 41024, 42335, 32236, 21736, 29423, 42510, 40228, 29582, 26142, 31496, 37619, 38367, 31450, 27914, 31815, 37254, 36588, 32138, 30024, 32809, 35489, 34147, 32744, 32371, 33065, 33842, 33810, 33332, 33390, 32965, 32964, 33614, 33730, 33609, 33360, 32032, 32713, 35417, 34517, 31201, 31731, 34491, 35148, 33815, 31497, 31345, 33953, 35906, 33836, 31505};

float temp_symbs[2*NUM_SYMBS];				// 2x N_BUFF for slack
float symbol_buffer[SYMBOL_BUFF];			// symbol buffer
uint8_t bits[BITS];

volatile uint8_t buff_flag_1 = RESET;
volatile uint8_t buff_flag_2 = RESET;
volatile uint8_t buff_process = RESET;

uint32_t start, end, demod_time, num_symbs, total_symbs, adc_start, adc_end, adc_time;
uint8_t t_str[NUM_CHARS];
float norm_samples[ADC_BUF_LEN];
float samples_d[ADC_BUF_LEN] = {0, 0, 0, 0, 0, 0};
float Quad[ADC_BUF_LEN] = {0, 0, 0, 0, 0, 0};
float filtered_samps[ADC_BUF_LEN + RRC_LEN - 1];

uint8_t packet_found;
uint8_t result;

/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
void PeriphCommonClock_Config(void);
static void MPU_Config(void);
static void MX_GPIO_Init(void);
static void MX_DMA_Init(void);
static void MX_ADC1_Init(void);
static void MX_ADC2_Init(void);
static void MX_USART3_UART_Init(void);
static void MX_TIM2_Init(void);
/* USER CODE BEGIN PFP */

/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */

/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{

  /* USER CODE BEGIN 1 */

  /* USER CODE END 1 */

  /* MPU Configuration--------------------------------------------------------*/
  MPU_Config();

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

/* Configure the peripherals common clocks */
  PeriphCommonClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_DMA_Init();
  MX_ADC1_Init();
  MX_ADC2_Init();
  MX_USART3_UART_Init();
  MX_TIM2_Init();
  /* USER CODE BEGIN 2 */

  // Start timers
  HAL_TIM_Base_Start(&htim2);

  // Starts slave ADC (ADC2); this must be started before ADC1. It won't do anything until triggered by ADC1 anyways.
  HAL_ADC_Start(&hadc2);

  // Starts master ADC (ADC1) with fancy multi DMA command. Here is where we specify which buffer the DMA should store values in and how large the buffer is
  HAL_ADCEx_MultiModeStart_DMA(&hadc1, (uint32_t*) adc_buf, ADC_BUF_LEN);

  uint16_t * samples;
  uint8_t packet_found;

  // setup params
  params_r params = {.CL_phase = 0,
  					 .CL_integrator = 0,
					 .TR_phase = 0,
					 .TR_integrator = 0,
					 .sps = SPS};

  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
  while (1)
  {
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */

	// execute one buffer at a time. Look at SWV console to see if computation time is too long
	// alias buffer for ease
	if (buff_flag_1) {
	  samples = buffer_1;
	}
	if (buff_flag_2) {
	  samples = buffer_2;
	}

	if (buff_flag_1 || buff_flag_2) {
	  packet_found = 0;
	  // demodulate buffer
	  start = __HAL_TIM_GET_COUNTER(&htim2);
	  num_symbs = demodulate(samples, temp_symbs, &params);
	  end = __HAL_TIM_GET_COUNTER(&htim2);

	  demod_time = end - start;

	  total_symbs += num_symbs;
	  // add temp_symbs to running buffer for correlation
	  // shift latest entries
	  for (int j = 0; j < SYMBOL_BUFF-num_symbs; j++) {
		  symbol_buffer[j] = symbol_buffer[j+num_symbs];
	  }
	  for (int j = 0; j < num_symbs; j++) {
		  symbol_buffer[SYMBOL_BUFF-1-num_symbs+j] = temp_symbs[j];
	  }

	  if (total_symbs >= NUM_SYMBS) {
			packet_found = find_packet(symbol_buffer, bits, SYMBOL_BUFF);
			if (packet_found) {
				for (int i = 0; i < NUM_SYMBS - (NUM_PACKET_H * 15); i = i+8) {
					result = 0;
					for(int j = 0; j < 8; j++)
					{
						result <<= 1;
						result += bits[i + j];
					}
					t_str[i>>3] = result;
				}
				HAL_UART_Transmit(&huart3, (uint8_t *)t_str, sizeof(t_str), 100);
			}

			total_symbs = 0;
	  }
	  buff_process = RESET;
	  buff_flag_1 = RESET;
	  buff_flag_2 = RESET;
	}

  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};
  RCC_CRSInitTypeDef RCC_CRSInitStruct = {0};

  /*AXI clock gating */
  RCC->CKGAENR = 0xFFFFFFFF;

  /** Supply configuration update enable
  */
  HAL_PWREx_ConfigSupply(PWR_DIRECT_SMPS_SUPPLY);

  /** Configure the main internal regulator output voltage
  */
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE0);

  while(!__HAL_PWR_GET_FLAG(PWR_FLAG_VOSRDY)) {}

  /** Configure LSE Drive Capability
  */
  HAL_PWR_EnableBkUpAccess();
  __HAL_RCC_LSEDRIVE_CONFIG(RCC_LSEDRIVE_LOW);

  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI48|RCC_OSCILLATORTYPE_HSI
                              |RCC_OSCILLATORTYPE_HSE|RCC_OSCILLATORTYPE_LSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.LSEState = RCC_LSE_ON;
  RCC_OscInitStruct.HSIState = RCC_HSI_DIV1;
  RCC_OscInitStruct.HSICalibrationValue = 64;
  RCC_OscInitStruct.HSI48State = RCC_HSI48_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 1;
  RCC_OscInitStruct.PLL.PLLN = 70;
  RCC_OscInitStruct.PLL.PLLP = 2;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLRGE = RCC_PLL1VCIRANGE_3;
  RCC_OscInitStruct.PLL.PLLVCOSEL = RCC_PLL1VCOWIDE;
  RCC_OscInitStruct.PLL.PLLFRACN = 0;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }

  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2
                              |RCC_CLOCKTYPE_D3PCLK1|RCC_CLOCKTYPE_D1PCLK1;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.SYSCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_HCLK_DIV1;
  RCC_ClkInitStruct.APB3CLKDivider = RCC_APB3_DIV2;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_APB1_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_APB2_DIV2;
  RCC_ClkInitStruct.APB4CLKDivider = RCC_APB4_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_6) != HAL_OK)
  {
    Error_Handler();
  }
  HAL_RCC_MCOConfig(RCC_MCO1, RCC_MCO1SOURCE_HSI, RCC_MCODIV_1);
  HAL_RCC_MCOConfig(RCC_MCO2, RCC_MCO2SOURCE_SYSCLK, RCC_MCODIV_1);

  /** Enable the SYSCFG APB clock
  */
  __HAL_RCC_CRS_CLK_ENABLE();

  /** Configures CRS
  */
  RCC_CRSInitStruct.Prescaler = RCC_CRS_SYNC_DIV1;
  RCC_CRSInitStruct.Source = RCC_CRS_SYNC_SOURCE_LSE;
  RCC_CRSInitStruct.Polarity = RCC_CRS_SYNC_POLARITY_RISING;
  RCC_CRSInitStruct.ReloadValue = __HAL_RCC_CRS_RELOADVALUE_CALCULATE(48000000,32768);
  RCC_CRSInitStruct.ErrorLimitValue = 34;
  RCC_CRSInitStruct.HSI48CalibrationValue = 32;

  HAL_RCCEx_CRSConfig(&RCC_CRSInitStruct);
}

/**
  * @brief Peripherals Common Clock Configuration
  * @retval None
  */
void PeriphCommonClock_Config(void)
{
  RCC_PeriphCLKInitTypeDef PeriphClkInitStruct = {0};

  /** Initializes the peripherals clock
  */
  PeriphClkInitStruct.PeriphClockSelection = RCC_PERIPHCLK_ADC;
  PeriphClkInitStruct.PLL2.PLL2M = 1;
  PeriphClkInitStruct.PLL2.PLL2N = 18;
  PeriphClkInitStruct.PLL2.PLL2P = 3;
  PeriphClkInitStruct.PLL2.PLL2Q = 2;
  PeriphClkInitStruct.PLL2.PLL2R = 2;
  PeriphClkInitStruct.PLL2.PLL2RGE = RCC_PLL2VCIRANGE_3;
  PeriphClkInitStruct.PLL2.PLL2VCOSEL = RCC_PLL2VCOWIDE;
  PeriphClkInitStruct.PLL2.PLL2FRACN = 6144;
  PeriphClkInitStruct.AdcClockSelection = RCC_ADCCLKSOURCE_PLL2;
  if (HAL_RCCEx_PeriphCLKConfig(&PeriphClkInitStruct) != HAL_OK)
  {
    Error_Handler();
  }
}

/**
  * @brief ADC1 Initialization Function
  * @param None
  * @retval None
  */
static void MX_ADC1_Init(void)
{

  /* USER CODE BEGIN ADC1_Init 0 */

  /* USER CODE END ADC1_Init 0 */

  ADC_MultiModeTypeDef multimode = {0};
  ADC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN ADC1_Init 1 */

  /* USER CODE END ADC1_Init 1 */

  /** Common config
  */
  hadc1.Instance = ADC1;
  hadc1.Init.ClockPrescaler = ADC_CLOCK_ASYNC_DIV1;
  hadc1.Init.Resolution = ADC_RESOLUTION_16B;
  hadc1.Init.ScanConvMode = ADC_SCAN_DISABLE;
  hadc1.Init.EOCSelection = ADC_EOC_SINGLE_CONV;
  hadc1.Init.LowPowerAutoWait = DISABLE;
  hadc1.Init.ContinuousConvMode = ENABLE;
  hadc1.Init.NbrOfConversion = 1;
  hadc1.Init.DiscontinuousConvMode = DISABLE;
  hadc1.Init.ExternalTrigConv = ADC_SOFTWARE_START;
  hadc1.Init.ExternalTrigConvEdge = ADC_EXTERNALTRIGCONVEDGE_NONE;
  hadc1.Init.ConversionDataManagement = ADC_CONVERSIONDATA_DMA_CIRCULAR;
  hadc1.Init.Overrun = ADC_OVR_DATA_PRESERVED;
  hadc1.Init.LeftBitShift = ADC_LEFTBITSHIFT_NONE;
  hadc1.Init.OversamplingMode = DISABLE;
  if (HAL_ADC_Init(&hadc1) != HAL_OK)
  {
    Error_Handler();
  }

  /** Configure the ADC multi-mode
  */
  multimode.Mode = ADC_DUALMODE_INTERL;
  multimode.DualModeData = ADC_DUALMODEDATAFORMAT_32_10_BITS;
  multimode.TwoSamplingDelay = ADC_TWOSAMPLINGDELAY_4CYCLES;
  if (HAL_ADCEx_MultiModeConfigChannel(&hadc1, &multimode) != HAL_OK)
  {
    Error_Handler();
  }

  /** Configure Regular Channel
  */
  sConfig.Channel = ADC_CHANNEL_3;
  sConfig.Rank = ADC_REGULAR_RANK_1;
  sConfig.SamplingTime = ADC_SAMPLETIME_1CYCLE_5;
  sConfig.SingleDiff = ADC_SINGLE_ENDED;
  sConfig.OffsetNumber = ADC_OFFSET_NONE;
  sConfig.Offset = 0;
  sConfig.OffsetSignedSaturation = DISABLE;
  if (HAL_ADC_ConfigChannel(&hadc1, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN ADC1_Init 2 */

  /* USER CODE END ADC1_Init 2 */

}

/**
  * @brief ADC2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_ADC2_Init(void)
{

  /* USER CODE BEGIN ADC2_Init 0 */

  /* USER CODE END ADC2_Init 0 */

  ADC_ChannelConfTypeDef sConfig = {0};

  /* USER CODE BEGIN ADC2_Init 1 */

  /* USER CODE END ADC2_Init 1 */

  /** Common config
  */
  hadc2.Instance = ADC2;
  hadc2.Init.ClockPrescaler = ADC_CLOCK_ASYNC_DIV1;
  hadc2.Init.Resolution = ADC_RESOLUTION_16B;
  hadc2.Init.ScanConvMode = ADC_SCAN_DISABLE;
  hadc2.Init.EOCSelection = ADC_EOC_SINGLE_CONV;
  hadc2.Init.LowPowerAutoWait = DISABLE;
  hadc2.Init.ContinuousConvMode = ENABLE;
  hadc2.Init.NbrOfConversion = 1;
  hadc2.Init.DiscontinuousConvMode = DISABLE;
  hadc2.Init.ConversionDataManagement = ADC_CONVERSIONDATA_DR;
  hadc2.Init.Overrun = ADC_OVR_DATA_PRESERVED;
  hadc2.Init.LeftBitShift = ADC_LEFTBITSHIFT_NONE;
  hadc2.Init.OversamplingMode = DISABLE;
  if (HAL_ADC_Init(&hadc2) != HAL_OK)
  {
    Error_Handler();
  }

  /** Configure Regular Channel
  */
  sConfig.Channel = ADC_CHANNEL_3;
  sConfig.Rank = ADC_REGULAR_RANK_1;
  sConfig.SamplingTime = ADC_SAMPLETIME_1CYCLE_5;
  sConfig.SingleDiff = ADC_SINGLE_ENDED;
  sConfig.OffsetNumber = ADC_OFFSET_NONE;
  sConfig.Offset = 0;
  sConfig.OffsetSignedSaturation = DISABLE;
  if (HAL_ADC_ConfigChannel(&hadc2, &sConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN ADC2_Init 2 */

  /* USER CODE END ADC2_Init 2 */

}

/**
  * @brief TIM2 Initialization Function
  * @param None
  * @retval None
  */
static void MX_TIM2_Init(void)
{

  /* USER CODE BEGIN TIM2_Init 0 */

  /* USER CODE END TIM2_Init 0 */

  TIM_ClockConfigTypeDef sClockSourceConfig = {0};
  TIM_MasterConfigTypeDef sMasterConfig = {0};

  /* USER CODE BEGIN TIM2_Init 1 */

  /* USER CODE END TIM2_Init 1 */
  htim2.Instance = TIM2;
  htim2.Init.Prescaler = 280;
  htim2.Init.CounterMode = TIM_COUNTERMODE_UP;
  htim2.Init.Period = 4294967295;
  htim2.Init.ClockDivision = TIM_CLOCKDIVISION_DIV1;
  htim2.Init.AutoReloadPreload = TIM_AUTORELOAD_PRELOAD_DISABLE;
  if (HAL_TIM_Base_Init(&htim2) != HAL_OK)
  {
    Error_Handler();
  }
  sClockSourceConfig.ClockSource = TIM_CLOCKSOURCE_INTERNAL;
  if (HAL_TIM_ConfigClockSource(&htim2, &sClockSourceConfig) != HAL_OK)
  {
    Error_Handler();
  }
  sMasterConfig.MasterOutputTrigger = TIM_TRGO_RESET;
  sMasterConfig.MasterSlaveMode = TIM_MASTERSLAVEMODE_DISABLE;
  if (HAL_TIMEx_MasterConfigSynchronization(&htim2, &sMasterConfig) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN TIM2_Init 2 */

  /* USER CODE END TIM2_Init 2 */

}

/**
  * @brief USART3 Initialization Function
  * @param None
  * @retval None
  */
static void MX_USART3_UART_Init(void)
{

  /* USER CODE BEGIN USART3_Init 0 */

  /* USER CODE END USART3_Init 0 */

  /* USER CODE BEGIN USART3_Init 1 */

  /* USER CODE END USART3_Init 1 */
  huart3.Instance = USART3;
  huart3.Init.BaudRate = 115200;
  huart3.Init.WordLength = UART_WORDLENGTH_8B;
  huart3.Init.StopBits = UART_STOPBITS_1;
  huart3.Init.Parity = UART_PARITY_NONE;
  huart3.Init.Mode = UART_MODE_TX_RX;
  huart3.Init.HwFlowCtl = UART_HWCONTROL_NONE;
  huart3.Init.OverSampling = UART_OVERSAMPLING_16;
  huart3.Init.OneBitSampling = UART_ONE_BIT_SAMPLE_DISABLE;
  huart3.Init.ClockPrescaler = UART_PRESCALER_DIV1;
  huart3.AdvancedInit.AdvFeatureInit = UART_ADVFEATURE_NO_INIT;
  if (HAL_UART_Init(&huart3) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_SetTxFifoThreshold(&huart3, UART_TXFIFO_THRESHOLD_1_8) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_SetRxFifoThreshold(&huart3, UART_RXFIFO_THRESHOLD_1_8) != HAL_OK)
  {
    Error_Handler();
  }
  if (HAL_UARTEx_DisableFifoMode(&huart3) != HAL_OK)
  {
    Error_Handler();
  }
  /* USER CODE BEGIN USART3_Init 2 */

  /* USER CODE END USART3_Init 2 */

}

/**
  * Enable DMA controller clock
  */
static void MX_DMA_Init(void)
{

  /* DMA controller clock enable */
  __HAL_RCC_DMA1_CLK_ENABLE();

  /* DMA interrupt init */
  /* DMA1_Stream0_IRQn interrupt configuration */
  HAL_NVIC_SetPriority(DMA1_Stream0_IRQn, 0, 0);
  HAL_NVIC_EnableIRQ(DMA1_Stream0_IRQn);

}

/**
  * @brief GPIO Initialization Function
  * @param None
  * @retval None
  */
static void MX_GPIO_Init(void)
{
  GPIO_InitTypeDef GPIO_InitStruct = {0};
/* USER CODE BEGIN MX_GPIO_Init_1 */
/* USER CODE END MX_GPIO_Init_1 */

  /* GPIO Ports Clock Enable */
  __HAL_RCC_GPIOC_CLK_ENABLE();
  __HAL_RCC_GPIOH_CLK_ENABLE();
  __HAL_RCC_GPIOA_CLK_ENABLE();
  __HAL_RCC_GPIOD_CLK_ENABLE();

  /*Configure GPIO pin Output Level */
  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_RESET);

  /*Configure GPIO pin : PA5 */
  GPIO_InitStruct.Pin = GPIO_PIN_5;
  GPIO_InitStruct.Mode = GPIO_MODE_OUTPUT_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_VERY_HIGH;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

  /*Configure GPIO pin : PC9 */
  GPIO_InitStruct.Pin = GPIO_PIN_9;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF0_MCO;
  HAL_GPIO_Init(GPIOC, &GPIO_InitStruct);

  /*Configure GPIO pin : PA8 */
  GPIO_InitStruct.Pin = GPIO_PIN_8;
  GPIO_InitStruct.Mode = GPIO_MODE_AF_PP;
  GPIO_InitStruct.Pull = GPIO_NOPULL;
  GPIO_InitStruct.Speed = GPIO_SPEED_FREQ_LOW;
  GPIO_InitStruct.Alternate = GPIO_AF0_MCO;
  HAL_GPIO_Init(GPIOA, &GPIO_InitStruct);

/* USER CODE BEGIN MX_GPIO_Init_2 */

/* USER CODE END MX_GPIO_Init_2 */
}

/* USER CODE BEGIN 4 */
void HAL_ADC_ConvHalfCpltCallback(ADC_HandleTypeDef* hadc) {
  // toggles buffer status pin so sampling rate can be measured
  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_SET);

  adc_start = __HAL_TIM_GET_COUNTER(&htim2);

  // copies ADC/DMA temp buffer into sample buffer
  if (!buff_process){
	  buff_process = SET;
	  buff_flag_1 = SET;
	  buff_flag_2 = RESET;
	  for(int j = 0; j < ADC_BUF_LEN/2; j++)
	  {
		  buffer_1[2*j] = (uint16_t)(adc_buf[j]&0x0000FFFF);
		  buffer_1[2*j+1] = (uint16_t)(adc_buf[j]>>16);
	  }
  }
}

// Called when buffer is completely filled
void HAL_ADC_ConvCpltCallback(ADC_HandleTypeDef* hadc) {
  // toggles buffer status pin so sampling rate can be measured
  HAL_GPIO_WritePin(GPIOA, GPIO_PIN_5, GPIO_PIN_RESET);

  adc_end = __HAL_TIM_GET_COUNTER(&htim2);
  adc_time = adc_end - adc_start;

  // copies ADC/DMA temp buffer into sample buffer
  if (!buff_process){
	  buff_process = SET;
	  buff_flag_2 = SET;
	  buff_flag_1 = RESET;
	  for(int j = 0; j < ADC_BUF_LEN/2; j++) {
		  buffer_2[2*j] = (uint16_t)(adc_buf[j+ADC_BUF_LEN/2]&0x0000FFFF);
		  buffer_2[2*j+1] = (uint16_t)(adc_buf[j+ADC_BUF_LEN/2]>>16);
	  }
  }
}

int demodulate(const uint16_t * samples, int * symbs, params_r * params) {

    normalize(samples, norm_samples);

//     Costas Loop
    costas_loop(norm_samples, samples_d, params);
    // filter w SRRC
    arm_conv_f32(samples_d, ADC_BUF_LEN, RRC, RRC_LEN, filtered_samps);
    // readjust window
    float shift = RRC_LEN/2. - 0.5;
    int k;
    for (int i = shift ; i < ADC_BUF_LEN+RRC_LEN-1-shift; i++) {
        k = i - shift;
        filtered_samps[k] = filtered_samps[i];
    }

    // timing recovery
    int bit_len = timing_recovery(filtered_samps, symbs, params);

    return bit_len;
}

void costas_loop(float * norm_samples, float * samples_d, params_r * params) {
    float phase = params->CL_phase;
    float inph[2*ORDER+1] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
    float quad[2*ORDER+1] = {0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0};
    float inph_[ORDER+1] = {0, 0, 0, 0, 0, 0};
    float quad_[ORDER+1] = {0, 0, 0, 0, 0, 0};
    double error = 0;
    float integrator = 0; //params->CL_integrator;

    float kp = 8.5;
    float ki = 0.1;
    float dt = (float)FC / (float)FS;

    for (int i = ORDER; i < ADC_BUF_LEN+ORDER; i++) {
        // define t from microcontroller
        int k = i - ORDER;
        inph_[ORDER] = norm_samples[k]*2*cos(2*M_PI*dt*k + phase);
        quad_[ORDER] = norm_samples[k]*-2*sin(2*M_PI*dt*k + phase);

        arm_conv_f32(inph_, ORDER+1, lp, ORDER+1, inph);
        arm_conv_f32(quad_, ORDER+1, lp, ORDER+1, quad);

        samples_d[k] = inph[ORDER];
        Quad[k] = quad[ORDER];

        error = inph[ORDER] * quad[ORDER];
        integrator += ki*error;
        phase = phase + kp*error + integrator;

        // shift the values of inph_ and quad_
        for (int jx = 1; jx < ORDER+1; jx++) {
            inph_[jx-1] = inph_[jx];
            quad_[jx-1] = quad_[jx];
        }
    }
    params->CL_phase = remainder(phase, 2*M_PI);
    params->CL_integrator = remainder(integrator, 2*M_PI);
}

uint8_t find_packet(float * symbs, uint8_t * bits, const int num_symbs) {
    // take cross correlation
    float xcorr_out[SYMBOL_BUFF+14];
    packet_found = 0;
    arm_correlate_f32(key, 15, symbs, num_symbs, xcorr_out);

    // find packet
    int shift = 0;
    for (int i = num_symbs-(NUM_PACKET_H-1)*15 - 1; i >= 0; i--) {
        if (fabs(xcorr_out[i]) > 14) {
            shift = SYMBOL_BUFF+14-i;
            packet_found = 1;
            if (xcorr_out[i] < 0) {
				for (int j = 0; j < BITS; j++) {
					symbs[shift + j] = symbs[shift+ j]*-1;
				}
            }
            break;
        }
    }

    if (!packet_found)
        return 0;

    // convert symbols to bits
    for (int i = 0; i < BITS; i++) {
        bits[i] = (symbs[shift+i]+1)*0.5;
    }
    return 1;
}

/* USER CODE END 4 */

 /* MPU Configuration */

void MPU_Config(void)
{
  MPU_Region_InitTypeDef MPU_InitStruct = {0};

  /* Disables the MPU */
  HAL_MPU_Disable();

  /** Initializes and configures the Region and the memory to be protected
  */
  MPU_InitStruct.Enable = MPU_REGION_ENABLE;
  MPU_InitStruct.Number = MPU_REGION_NUMBER0;
  MPU_InitStruct.BaseAddress = 0x0;
  MPU_InitStruct.Size = MPU_REGION_SIZE_4GB;
  MPU_InitStruct.SubRegionDisable = 0x87;
  MPU_InitStruct.TypeExtField = MPU_TEX_LEVEL0;
  MPU_InitStruct.AccessPermission = MPU_REGION_NO_ACCESS;
  MPU_InitStruct.DisableExec = MPU_INSTRUCTION_ACCESS_DISABLE;
  MPU_InitStruct.IsShareable = MPU_ACCESS_SHAREABLE;
  MPU_InitStruct.IsCacheable = MPU_ACCESS_NOT_CACHEABLE;
  MPU_InitStruct.IsBufferable = MPU_ACCESS_NOT_BUFFERABLE;

  HAL_MPU_ConfigRegion(&MPU_InitStruct);
  /* Enables the MPU */
  HAL_MPU_Enable(MPU_PRIVILEGED_DEFAULT);

}

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */
